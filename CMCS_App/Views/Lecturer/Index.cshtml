@model IEnumerable<CMCS_App.Models.Claim>

@{
    ViewData["Title"] = "Lecturer Dashboard";
}

<div class="container mt-4">
    <h2 class="mb-4 text-primary">Lecturer Dashboard</h2>

    <!-- Success/Error Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i> <strong>Success!</strong> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle"></i> <strong>Error!</strong> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Submit Claim -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-file-invoice"></i> Submit a New Claim</h5>
        </div>
        <div class="card-body">
            <form asp-action="SubmitClaim" method="post" enctype="multipart/form-data" id="claimForm">
                @Html.AntiForgeryToken()

                <!-- Instructions Alert -->
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle"></i> <strong>Quick Guide:</strong>
                    Fill in your module details, hours worked, and hourly rate. The total amount will be calculated automatically.
                    Upload supporting documents if you have any (this is optional). Click "Submit Claim" when ready.
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="ModuleName" class="form-label">
                                Module Name <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="ModuleName" name="ModuleName"
                                   required placeholder="e.g., Computer Science" maxlength="100" />
                            <div class="form-text">Enter the name of the module you're teaching</div>
                        </div>

                        <div class="mb-3">
                            <label for="HourlyRate" class="form-label">
                                Hourly Rate (R) <span class="text-danger">*</span>
                            </label>
                            <input type="number" class="form-control" id="HourlyRate" name="HourlyRate"
                                   step="0.01" min="0.01" max="1000" required
                                   placeholder="Enter hourly rate" />
                            <small class="form-text text-muted">Rate must be between R0.01 and R1000.00</small>
                        </div>

                        <div class="mb-3">
                            <label for="Month" class="form-label">
                                Month <span class="text-danger">*</span>
                            </label>
                            <select class="form-control" id="Month" name="Month" required>
                                <option value="">Select Month</option>
                                <option value="January">January</option>
                                <option value="February">February</option>
                                <option value="March">March</option>
                                <option value="April">April</option>
                                <option value="May">May</option>
                                <option value="June">June</option>
                                <option value="July">July</option>
                                <option value="August">August</option>
                                <option value="September">September</option>
                                <option value="October">October</option>
                                <option value="November">November</option>
                                <option value="December">December</option>
                            </select>
                            <div class="form-text">Select the month for this claim</div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="HoursWorked" class="form-label">
                                Hours Worked <span class="text-danger">*</span>
                            </label>
                            <input type="number" class="form-control" id="HoursWorked" name="HoursWorked"
                                   min="1" max="200" required placeholder="Enter hours worked" />
                            <small class="form-text text-muted">Hours must be between 1 and 200</small>
                        </div>

                        <div class="mb-3">
                            <label for="TotalAmount" class="form-label">
                                Total Amount (R) <span class="badge bg-secondary">Auto-calculated</span>
                            </label>
                            <input type="text" class="form-control bg-light" id="TotalAmount" readonly
                                   placeholder="Will be calculated automatically" />
                            <div class="form-text text-success" id="calculationInfo">
                                <i class="fas fa-calculator"></i> Total = Hours Worked × Hourly Rate
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="SupportingDocument" class="form-label">
                                Upload Supporting Document
                                <span class="badge bg-info">Optional</span>
                                <i class="fas fa-question-circle" data-bs-toggle="tooltip"
                                   title="Upload timesheets, attendance records, or other supporting documents"></i>
                            </label>
                            <input type="file" class="form-control" id="SupportingDocument" name="supportingDocument"
                                   accept=".pdf,.docx,.xlsx,.jpg,.jpeg,.png" />
                            <div class="form-text">
                                <strong>Accepted formats:</strong> PDF, DOCX, XLSX, JPG, PNG<br />
                                <strong>Maximum size:</strong> 5MB<br />
                                <strong>Note:</strong> Uploading a document is optional but recommended for verification
                            </div>
                            <div id="fileInfo" class="mt-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Validation Summary -->
                <div id="validationSummary" class="alert alert-warning d-none" role="alert">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Please check:</strong>
                    <ul id="validationList" class="mb-0 mt-2"></ul>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="reset" class="btn btn-secondary" id="clearBtn">
                        <i class="fas fa-times"></i> Clear Form
                    </button>
                    <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                        <i class="fas fa-paper-plane"></i> Submit Claim
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">@Model.Count()</h5>
                    <p class="card-text">Total Claims</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">@Model.Count(c => c.Status == "Submitted")</h5>
                    <p class="card-text">Pending Review</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">@Model.Count(c => c.Status.Contains("Approved"))</h5>
                    <p class="card-text">Approved</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger">
                <div class="card-body">
                    <h5 class="card-title">@Model.Count(c => c.Status.Contains("Rejected"))</h5>
                    <p class="card-text">Rejected</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Claim Status -->
    <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            <span><i class="fas fa-history"></i> My Claim History</span>
            <span class="badge bg-light text-dark">@Model.Count() claims</span>
        </div>
        <div class="card-body">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-bordered table-striped align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Claim ID</th>
                                <th>Module</th>
                                <th>Month</th>
                                <th>Hours</th>
                                <th>Hourly Rate</th>
                                <th>Total Amount</th>
                                <th>Document</th>
                                <th>Status</th>
                                <th>Rejection Reason</th>
                                <th>Submission Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var claim in Model)
                            {
                                <tr>
                                    <td><strong>#@claim.ClaimID</strong></td>
                                    <td>@claim.ModuleName</td>
                                    <td>@claim.Month</td>
                                    <td>@claim.HoursWorked hrs</td>
                                    <td>R @claim.HourlyRate.ToString("N2")</td>
                                    <td><strong>R @claim.TotalAmount.ToString("N2")</strong></td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(claim.SupportingDocument))
                                        {
                                            <a asp-action="DownloadDocument" asp-route-claimId="@claim.ClaimID" asp-route-fileName="@claim.SupportingDocument"
                                               class="btn btn-sm btn-info text-decoration-none">
                                                <i class="fas fa-download"></i> Download
                                            </a>
                                        }
                                        else
                                        {
                                            <span class="text-muted">No document</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge @GetStatusBadgeClass(claim.Status)">
                                            @claim.Status
                                        </span>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(claim.RejectionReason))
                                        {
                                            <small class="text-danger"><strong>@claim.RejectionReason</strong></small>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>@claim.SubmissionDate.ToString("dd MMM yyyy HH:mm")</td>
                                    <td>
                                        <a asp-action="Details" asp-route-id="@claim.ClaimID"
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i> View
                                        </a>
                                        @if (claim.Status == "Submitted")
                                        {
                                            <form asp-action="DeleteClaim" method="post" class="d-inline"
                                                  onsubmit="return confirm('Are you sure you want to delete this claim?');">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@claim.ClaimID" />
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </form>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center text-muted py-5">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <h5>No claims submitted yet</h5>
                    <p>Use the form above to submit your first claim.</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Success Modal for Claim Submission -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle"></i> Claim Submitted Successfully!
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center py-3">
                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                    <h4 class="mt-3">Your claim has been submitted!</h4>
                    <p class="text-muted">
                        Claim ID: <strong id="modalClaimId"></strong><br>
                        Total Amount: <strong id="modalTotalAmount"></strong><br>
                        Status: <span class="badge bg-warning">Pending Review</span>
                    </p>
                    <p>You will be notified once the Programme Coordinator reviews your claim.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="fas fa-check"></i> Got it!
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('claimForm');
            const hoursInput = document.getElementById('HoursWorked');
            const rateInput = document.getElementById('HourlyRate');
            const totalInput = document.getElementById('TotalAmount');
            const fileInput = document.getElementById('SupportingDocument');
            const fileInfo = document.getElementById('fileInfo');
            const submitBtn = document.getElementById('submitBtn');
            const clearBtn = document.getElementById('clearBtn');
            const validationSummary = document.getElementById('validationSummary');
            const validationList = document.getElementById('validationList');

            // Calculate total amount automatically
            function calculateTotal() {
                const hours = parseFloat(hoursInput.value) || 0;
                const rate = parseFloat(rateInput.value) || 0;
                const total = hours * rate;
                totalInput.value = 'R ' + total.toFixed(2);

                // Update calculation info with animation
                if (hours > 0 && rate > 0) {
                    document.getElementById('calculationInfo').innerHTML =
                        '<i class="fas fa-calculator"></i> ' + hours + ' hours × R' + rate.toFixed(2) + ' = <strong>R' + total.toFixed(2) + '</strong>';
                }
            }

            hoursInput.addEventListener('input', calculateTotal);
            rateInput.addEventListener('input', calculateTotal);

            // Real-time form validation
            function validateForm() {
                const errors = [];

                const moduleName = document.getElementById('ModuleName').value.trim();
                const hours = parseFloat(hoursInput.value);
                const rate = parseFloat(rateInput.value);
                const month = document.getElementById('Month').value;

                if (!moduleName) {
                    errors.push('Module name is required');
                }
                if (!month) {
                    errors.push('Please select a month');
                }
                if (isNaN(hours) || hours < 1 || hours > 200) {
                    errors.push('Hours must be between 1 and 200');
                }
                if (isNaN(rate) || rate < 0.01 || rate > 1000) {
                    errors.push('Hourly rate must be between R0.01 and R1000');
                }

                if (errors.length > 0) {
                    validationList.innerHTML = errors.map(e => '<li>' + e + '</li>').join('');
                    validationSummary.classList.remove('d-none');
                    return false;
                } else {
                    validationSummary.classList.add('d-none');
                    return true;
                }
            }

            // File upload feedback with enhanced visuals
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    const allowedTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                         'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                                         'image/jpeg', 'image/jpg', 'image/png'];

                    if (file.size > 5 * 1024 * 1024) {
                        fileInfo.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> File size exceeds 5MB limit! Please choose a smaller file.</div>';
                        this.value = '';
                    } else if (!allowedTypes.includes(file.type)) {
                        fileInfo.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Invalid file type! Please upload PDF, DOCX, XLSX, JPG, or PNG.</div>';
                        this.value = '';
                    } else {
                        fileInfo.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> File selected: <strong>' + file.name + '</strong> (' + sizeMB + ' MB)</div>';
                    }
                } else {
                    fileInfo.innerHTML = '';
                }
            });

            // Form submission with validation
            form.addEventListener('submit', function(e) {
                if (!validateForm()) {
                    e.preventDefault();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    return false;
                }

                // Show loading state
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...';
                submitBtn.disabled = true;
            });

            // Clear form with confirmation
            clearBtn.addEventListener('click', function(e) {
                if (form.querySelector('input[type="text"]').value !== '' ||
                    form.querySelector('input[type="number"]').value !== '') {
                    if (!confirm('Are you sure you want to clear all form fields?')) {
                        e.preventDefault();
                        return false;
                    }
                }
                fileInfo.innerHTML = '';
                validationSummary.classList.add('d-none');
                totalInput.value = '';
            });

            // Initialize calculation on page load
            calculateTotal();

            // Auto-dismiss alerts after 8 seconds
            setTimeout(function() {
                const alerts = document.querySelectorAll('.alert-dismissible');
                alerts.forEach(function(alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                });
            }, 8000);

            // Show success modal if claim was just submitted (check for success message)
            @if (TempData["SuccessMessage"] != null && TempData["SuccessMessage"].ToString().Contains("submitted"))
            {
                    <text>
                    setTimeout(function() {
                        var successModal = new bootstrap.Modal(document.getElementById('successModal'));
                        successModal.show();
                    }, 500);
                    </text>
            }
        });
    </script>
}

@functions {
    public string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Submitted" => "bg-warning text-dark",
            "Approved by Coordinator" => "bg-info text-dark",
            "Approved by Manager" => "bg-success",
            _ when status.Contains("Rejected") => "bg-danger",
            _ => "bg-secondary"
        };
    }
}